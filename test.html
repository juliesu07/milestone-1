<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Shorts</title>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
            overflow-x: hidden;
            background-color: #f4f4f4;
        }
        .videoContainer {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            height: 100vh;
            align-items: center;
            justify-content: flex-start;
        }

        .videoItem {
            scroll-snap-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
        }

        .buttonsContainer {
            display: flex;
            flex-direction: column;
            position: relative;
            padding-left: 20px;
            padding-top: 20px;
        }

        .likeDislikeBtn {
            width: 80px;
            padding: 10px;
            margin: 5px 0;
            background-color: #8e8e8e;
            color: white;
            font-size: 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="playPauseBtn">
        <button>Play/Pause</button>
    </div>
    <div class="videoContainer" id="videoList">
        <!-- Videos will be dynamically added here -->
    </div>

    <script>
        const playPauseBtn = document.getElementById('playPauseBtn');
        
        let currentVideoId = window.location.pathname.split('/').pop() || 'defaultId';
        let historyIndex = 0;
        let watchHistory = [];
        let currentPlayer = null;

        // Function to create video DOM elements
        function createVideoPlayer(videoId) {
            const videoItem = document.createElement('div');
            videoItem.classList.add('videoItem');

            const videoElement = document.createElement('video');
            videoElement.setAttribute('controls', true);
            videoElement.id = `videoPlayer_${videoId}`;
            videoElement.style.width = "70%";

            const buttonsContainer = document.createElement('div');
            buttonsContainer.classList.add('buttonsContainer');

            const likeBtn = document.createElement('button');
            likeBtn.textContent = 'Like';
            likeBtn.setAttribute('name', 'like');

            const dislikeBtn = document.createElement('button');
            dislikeBtn.textContent = 'Dislike';
            dislikeBtn.setAttribute('name', 'dislike');

            likeBtn.addEventListener('click', () => {
                likeBtn.classList.toggle('liked');
                dislikeBtn.classList.remove('disliked');
                const isLiked = likeBtn.classList.contains('liked') ? true : null;
                fetch('/api/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: videoId, value: isLiked })
                }).catch(error => console.error(`Error updating like on video ${videoId}: ${error}`));
            });

            dislikeBtn.addEventListener('click', () => {
                dislikeBtn.classList.toggle('disliked');
                likeBtn.classList.remove('liked');
                const isDisliked = dislikeBtn.classList.contains('disliked') ? false : null;
                fetch('/api/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: videoId, value: isDisliked })
                }).catch(error => console.error(`Error updating dislike on video ${videoId}: ${error}`));
            });

            buttonsContainer.appendChild(likeBtn);
            buttonsContainer.appendChild(dislikeBtn);

            videoItem.appendChild(videoElement);
            videoItem.appendChild(buttonsContainer);

            document.getElementById('videoList').appendChild(videoItem);

            const mediaUrl = `/media/${videoId}.mpd`;
            player = dashjs.MediaPlayer().create();
            player.initialize(videoElement, mediaUrl, false);

            watchHistory.push({ videoId: videoId, player: player });
        }

        // Load initial video
        function loadInitialVideo() {
            createVideoPlayer(currentVideoId);
            currentPlayer = watchHistory[0].player;
        }
        
        playPauseBtn.onclick = () => {
          if (currentPlayer) {
            if (currentPlayer.isPaused()) { currentPlayer.play(); } 
            else { currentPlayer.pause(); }
          }
        }

        // Scroll handling with IntersectionObserver
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const videoId = entry.target.id.split('_')[1];
                    if (videoId) {
                        loadVideo(videoId);
                    }
                }
            });
        }, { threshold: 0.1 });

        // Observe newly added video players
        setInterval(() => {
            const videos = document.querySelectorAll('[id^="videoPlayer_"]');
            videos.forEach(video => observer.observe(video));
        }, 1000);

        // Load a new video when scrolled
        function loadVideo(id) {
            const existingVideo = watchHistory.find(i => i.videoId === id);
            if (!existingVideo) { createVideoPlayer(id); }

            historyIndex = watchHistory.findIndex(i => i.videoId === id);
            currentPlayer = watchHistory[historyIndex].player;

            const videoElement = document.getElementById(`videoPlayer_${id}`);
            videoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Handle scroll
        window.addEventListener('wheel', async (event) => {
            if (event.deltaY > 0 && historyIndex < watchHistory.length - 1) {
                historyIndex++;
            } else if (event.deltaY < 0 && historyIndex > 0) {
                historyIndex--;
            }

            const videoElement = watchHistory[historyIndex].videoId;
            loadVideo(videoElement);
        });

        // Load initial video on page load
        loadInitialVideo();

        // Preload possible video recommendations
        async function preloadVideos(count) {
            try {
                const response = await fetch('/api/videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count: count })
                });

                const data = await response.json();

                if (data && Array.isArray(data.videos)) {
                    data.videos.forEach(vid => createVideoPlayer(vid.id));
                } else {
                    console.error('Invalid response format: "videos" not found in data', data);
                }
            } catch (error) {
                console.error('Error preloading videos:', error);
            }
        }

        preloadVideos(5);
    </script>
</body>
</html>
